// ========================================
// üññ STABLE VERSION 1.0.0 - BACKUP
// DO NOT MODIFY THIS FILE
// ========================================

import React, { useState, useEffect } from 'react';
import { Motorcycle } from '../types';

interface BikeFormProps {
  bike?: Motorcycle | null;
  onSave: (bike: Motorcycle, newMake?: string, newModel?: string) => void;
  onCancel: () => void;
  makes: string[];
  models: Record<string, string[]>;
}

export const BikeForm: React.FC<BikeFormProps> = ({
  bike,
  onSave,
  onCancel,
  makes,
  models,
}) => {
  const [currentStep, setCurrentStep] = useState(1);
  const [showNewMake, setShowNewMake] = useState(false);
  const [showNewModel, setShowNewModel] = useState(false);

  const [formData, setFormData] = useState({
    currentOdometer: '',
    make: '',
    newMake: '',
    model: '',
    newModel: '',
    registrationNumber: '',
    chassisNumber: '',
    insuranceValidity: '',
    pollutionValidity: '',
    fitnessValidity: '',
    roadTaxValidity: '',
    serviceIntervalMonths: 5,
    serviceIntervalKms: 5000,
    lastServiceDate: '',
    lastServiceKm: '',
  });

  useEffect(() => {
    if (bike) {
      const latestReading = bike.kmReadings?.sort((a, b) => 
        new Date(b.date).getTime() - new Date(a.date).getTime()
      )[0];
      
      setFormData({
        currentOdometer: latestReading?.kilometers?.toString() || '0',
        make: bike.make || '',
        newMake: '',
        model: bike.model || '',
        newModel: '',
        registrationNumber: bike.registrationNumber || '',
        chassisNumber: bike.chassisNumber || '',
        insuranceValidity: bike.insuranceValidity || '',
        pollutionValidity: bike.pollutionValidity || '',
        fitnessValidity: bike.fitnessValidity || '',
        roadTaxValidity: bike.roadTaxValidity || '',
        serviceIntervalMonths: bike.serviceIntervalMonths || 5,
        serviceIntervalKms: bike.serviceIntervalKms || 5000,
        lastServiceDate: bike.lastServiceDate || '',
        lastServiceKm: bike.lastServiceKm?.toString() || '',
      });
    }
  }, [bike]);

  const handleChange = (field: string, value: string | number) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleMakeSelect = (value: string) => {
    if (value === '__new__') {
      setShowNewMake(true);
      setFormData(prev => ({ ...prev, make: '', model: '' }));
    } else {
      setShowNewMake(false);
      setFormData(prev => ({ ...prev, make: value, model: '', newMake: '' }));
    }
  };

  const handleModelSelect = (value: string) => {
    if (value === '__new__') {
      setShowNewModel(true);
      setFormData(prev => ({ ...prev, model: '' }));
    } else {
      setShowNewModel(false);
      setFormData(prev => ({ ...prev, model: value, newModel: '' }));
    }
  };

  const handleSubmit = () => {
    const finalMake = showNewMake ? formData.newMake : formData.make;
    const finalModel = showNewModel ? formData.newModel : formData.model;

    if (!formData.currentOdometer || !finalMake || !finalModel || !formData.registrationNumber) {
      alert('Please fill in all required fields: Current Odometer, Make, Model, and Registration Number');
      return;
    }

    const currentKm = parseInt(formData.currentOdometer) || 0;
    const today = new Date().toISOString().split('T')[0];

    const newBike: Motorcycle = {
      id: bike?.id || crypto.randomUUID(),
      make: finalMake,
      model: finalModel,
      registrationNumber: formData.registrationNumber,
      chassisNumber: formData.chassisNumber,
      insuranceValidity: formData.insuranceValidity,
      pollutionValidity: formData.pollutionValidity,
      fitnessValidity: formData.fitnessValidity,
      roadTaxValidity: formData.roadTaxValidity,
      serviceIntervalMonths: formData.serviceIntervalMonths,
      serviceIntervalKms: formData.serviceIntervalKms,
      lastServiceDate: formData.lastServiceDate,
      lastServiceKm: parseInt(formData.lastServiceKm) || 0,
      kmReadings: bike?.kmReadings || [{ id: crypto.randomUUID(), date: today, kilometers: currentKm }],
      createdAt: bike?.createdAt || new Date().toISOString(),
    };

    // Add new km reading if odometer changed
    if (bike) {
      const latestReading = bike.kmReadings?.sort((a, b) => 
        new Date(b.date).getTime() - new Date(a.date).getTime()
      )[0];
      
      if (!latestReading || latestReading.kilometers !== currentKm) {
        const existingTodayIndex = newBike.kmReadings.findIndex(r => r.date === today);
        if (existingTodayIndex >= 0) {
          newBike.kmReadings[existingTodayIndex].kilometers = currentKm;
        } else {
          newBike.kmReadings.push({ id: crypto.randomUUID(), date: today, kilometers: currentKm });
        }
      }
    }

    onSave(
      newBike, 
      showNewMake ? formData.newMake : undefined, 
      showNewModel ? formData.newModel : undefined
    );
  };

  const currentMake = showNewMake ? formData.newMake : formData.make;
  const availableModels = currentMake && models[currentMake] ? models[currentMake] : [];

  const steps = [
    { num: 1, title: 'Basic', icon: 'üèçÔ∏è' },
    { num: 2, title: 'Documents', icon: 'üìÑ' },
    { num: 3, title: 'Service', icon: 'üîß' },
  ];

  return (
    <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-2 sm:p-4">
      <div className="bg-white w-full max-w-2xl max-h-[95vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
        
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-bold">
              {bike ? '‚úèÔ∏è Edit Motorcycle' : '‚ûï Add New Motorcycle'}
            </h2>
            <button onClick={onCancel} className="text-white/80 hover:text-white text-2xl">
              ‚úï
            </button>
          </div>
          
          {/* Step Indicators */}
          <div className="flex items-center justify-center gap-2 mt-4">
            {steps.map((step, index) => (
              <React.Fragment key={step.num}>
                <button
                  onClick={() => setCurrentStep(step.num)}
                  className={`flex items-center gap-1 px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                    currentStep === step.num
                      ? 'bg-white text-blue-600'
                      : 'bg-white/20 text-white hover:bg-white/30'
                  }`}
                >
                  <span>{step.icon}</span>
                  <span className="hidden sm:inline">{step.title}</span>
                </button>
                {index < steps.length - 1 && (
                  <div className="w-8 h-0.5 bg-white/30" />
                )}
              </React.Fragment>
            ))}
          </div>
        </div>

        {/* Form Content */}
        <div className="flex-1 overflow-y-auto p-4">
          
          {/* Step 1: Basic Info */}
          {currentStep === 1 && (
            <div className="space-y-4">

              {/* Make */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üè≠ Make / Brand *
                </label>
                {!showNewMake ? (
                  <select
                    value={formData.make}
                    onChange={(e) => handleMakeSelect(e.target.value)}
                    className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                    required
                  >
                    <option value="">-- Select Make --</option>
                    {makes.map((make) => (
                      <option key={make} value={make}>{make}</option>
                    ))}
                    <option value="__new__">‚ûï Add New Make</option>
                  </select>
                ) : (
                  <div className="space-y-2">
                    <input
                      type="text"
                      value={formData.newMake}
                      onChange={(e) => handleChange('newMake', e.target.value)}
                      placeholder="Enter new make (e.g., Honda, Yamaha)"
                      className="w-full px-4 py-3 text-lg border-2 border-blue-400 rounded-xl bg-blue-50 focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                      autoFocus
                    />
                    <button
                      type="button"
                      onClick={() => setShowNewMake(false)}
                      className="text-sm text-gray-500 hover:text-gray-700"
                    >
                      ‚Üê Back to list
                    </button>
                  </div>
                )}
              </div>

              {/* Model */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üèçÔ∏è Model *
                </label>
                {!showNewModel ? (
                  <select
                    value={formData.model}
                    onChange={(e) => handleModelSelect(e.target.value)}
                    className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                    required
                    disabled={!currentMake}
                  >
                    <option value="">-- Select Model --</option>
                    {availableModels.map((model) => (
                      <option key={model} value={model}>{model}</option>
                    ))}
                    <option value="__new__">‚ûï Add New Model</option>
                  </select>
                ) : (
                  <div className="space-y-2">
                    <input
                      type="text"
                      value={formData.newModel}
                      onChange={(e) => handleChange('newModel', e.target.value)}
                      placeholder="Enter new model (e.g., Activa 6G, FZ-S)"
                      className="w-full px-4 py-3 text-lg border-2 border-blue-400 rounded-xl bg-blue-50 focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                      autoFocus
                    />
                    <button
                      type="button"
                      onClick={() => setShowNewModel(false)}
                      className="text-sm text-gray-500 hover:text-gray-700"
                    >
                      ‚Üê Back to list
                    </button>
                  </div>
                )}
                {!currentMake && (
                  <p className="text-amber-600 text-sm mt-2">‚ö†Ô∏è Please select a Make first</p>
                )}
              </div>

              {/* Registration Number */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üî¢ Registration Number *
                </label>
                <input
                  type="text"
                  value={formData.registrationNumber}
                  onChange={(e) => handleChange('registrationNumber', e.target.value.toUpperCase())}
                  placeholder="e.g., MH01AB1234"
                  className="w-full px-4 py-3 text-lg font-mono uppercase border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                  required
                />
              </div>

              {/* Chassis Number */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üî© Chassis Number
                </label>
                <input
                  type="text"
                  value={formData.chassisNumber}
                  onChange={(e) => handleChange('chassisNumber', e.target.value.toUpperCase())}
                  placeholder="e.g., MD2A14AZ8RWD12345"
                  className="w-full px-4 py-3 text-lg font-mono uppercase border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                />
              </div>

              {/* Current Odometer Reading */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üî¢ Current Odometer Reading (KM) *
                </label>
                <input
                  type="number"
                  value={formData.currentOdometer}
                  onChange={(e) => handleChange('currentOdometer', e.target.value)}
                  placeholder="e.g., 15000"
                  className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                  required
                />
              </div>
            </div>
          )}

          {/* Step 2: Documents */}
          {currentStep === 2 && (
            <div className="space-y-4">
              <div className="bg-blue-50 rounded-xl p-4 mb-4">
                <p className="text-blue-800 font-medium">üìÑ Enter document validity dates to get renewal reminders</p>
              </div>

              {/* Insurance */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üõ°Ô∏è Insurance Valid Till
                </label>
                <input
                  type="date"
                  value={formData.insuranceValidity}
                  onChange={(e) => handleChange('insuranceValidity', e.target.value)}
                  className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                />
              </div>

              {/* Pollution */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üí® Pollution Certificate Valid Till
                </label>
                <input
                  type="date"
                  value={formData.pollutionValidity}
                  onChange={(e) => handleChange('pollutionValidity', e.target.value)}
                  className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                />
              </div>

              {/* Fitness */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  ‚úÖ Fitness Certificate Valid Till
                </label>
                <input
                  type="date"
                  value={formData.fitnessValidity}
                  onChange={(e) => handleChange('fitnessValidity', e.target.value)}
                  className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                />
              </div>

              {/* Road Tax */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üõ£Ô∏è Road Tax Valid Till
                </label>
                <input
                  type="date"
                  value={formData.roadTaxValidity}
                  onChange={(e) => handleChange('roadTaxValidity', e.target.value)}
                  className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                />
              </div>
            </div>
          )}

          {/* Step 3: Service */}
          {currentStep === 3 && (
            <div className="space-y-4">
              <div className="bg-amber-50 rounded-xl p-4 mb-4">
                <p className="text-amber-800 font-medium">üîß Set service intervals to get maintenance reminders</p>
              </div>

              {/* Service Interval - Months */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üìÖ Service Interval (Months)
                </label>
                <select
                  value={formData.serviceIntervalMonths}
                  onChange={(e) => handleChange('serviceIntervalMonths', parseInt(e.target.value))}
                  className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                >
                  <option value={3}>Every 3 months</option>
                  <option value={4}>Every 4 months</option>
                  <option value={5}>Every 5 months (Recommended)</option>
                  <option value={6}>Every 6 months</option>
                  <option value={9}>Every 9 months</option>
                  <option value={12}>Every 12 months</option>
                </select>
              </div>

              {/* Service Interval - KM */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üõ£Ô∏è Service Interval (Kilometers)
                </label>
                <select
                  value={formData.serviceIntervalKms}
                  onChange={(e) => handleChange('serviceIntervalKms', parseInt(e.target.value))}
                  className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                >
                  <option value={3000}>Every 3,000 KM</option>
                  <option value={4000}>Every 4,000 KM</option>
                  <option value={5000}>Every 5,000 KM (Recommended)</option>
                  <option value={6000}>Every 6,000 KM</option>
                  <option value={8000}>Every 8,000 KM</option>
                  <option value={10000}>Every 10,000 KM</option>
                </select>
              </div>

              {/* Last Service Date */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üìÜ Last Service Date
                </label>
                <input
                  type="date"
                  value={formData.lastServiceDate}
                  onChange={(e) => handleChange('lastServiceDate', e.target.value)}
                  className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                />
              </div>

              {/* Last Service KM */}
              <div className="bg-gray-50 rounded-xl p-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  üî¢ Last Service Odometer (KM)
                </label>
                <input
                  type="number"
                  value={formData.lastServiceKm}
                  onChange={(e) => handleChange('lastServiceKm', e.target.value)}
                  placeholder="e.g., 15000"
                  className="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                />
              </div>

              {/* Summary */}
              {formData.lastServiceDate && formData.currentOdometer && (
                <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                  <h4 className="font-bold text-green-800 mb-2">üìä Service Summary</h4>
                  <div className="space-y-1 text-sm text-green-700">
                    <p>Current Odometer: <strong>{parseInt(formData.currentOdometer).toLocaleString()} KM</strong></p>
                    <p>Last Service: <strong>{formData.lastServiceDate}</strong> at <strong>{parseInt(formData.lastServiceKm || '0').toLocaleString()} KM</strong></p>
                    <p>KM Since Last Service: <strong>{(parseInt(formData.currentOdometer) - parseInt(formData.lastServiceKm || '0')).toLocaleString()} KM</strong></p>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>

        {/* Footer Navigation */}
        <div className="border-t bg-gray-50 p-4">
          <div className="flex items-center justify-between gap-3">
            <button
              type="button"
              onClick={onCancel}
              className="px-4 py-2.5 text-gray-600 hover:text-gray-800 font-medium"
            >
              Cancel
            </button>

            <div className="flex items-center gap-2">
              {currentStep > 1 && (
                <button
                  type="button"
                  onClick={() => setCurrentStep(currentStep - 1)}
                  className="px-4 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-xl"
                >
                  ‚Üê Previous
                </button>
              )}
              
              {currentStep < 3 ? (
                <button
                  type="button"
                  onClick={() => setCurrentStep(currentStep + 1)}
                  className="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-xl"
                >
                  Next ‚Üí
                </button>
              ) : (
                <button
                  type="button"
                  onClick={handleSubmit}
                  className="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl"
                >
                  ‚úì Save Motorcycle
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};
